<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ورود به تعاونی مصرف کارکنان سازمان حج و زیارت</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.20/dist/full.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@fontsource/vazirmatn@latest/index.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Vazirmatn, sans-serif; background: linear-gradient(to right, #a8e6cf, #dcedc1); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
        <h1 class="text-2xl font-bold text-center mb-6">ورود به تعاونی مصرف کارکنان سازمان حج و زیارت</h1>
        <div id="step-1">
            <label class="block mb-2">شماره موبایل خود را وارد کنید:</label>
            <input type="tel" id="phoneInput" class="input input-bordered w-full mb-4" placeholder="مثال: 09123456789" maxlength="11">
            <button onclick="sendCode()" class="btn btn-success w-full">ارسال کد تایید</button>
            <p id="msg" class="text-sm text-red-500 mt-2"></p>
        </div>
        <div id="step-2" class="hidden">
            <label class="block mb-2">کد تایید را وارد کنید:</label>
            <input type="text" id="otpInput" class="input input-bordered w-full mb-4" maxlength="5">
            <button onclick="verifyCode()" class="btn btn-primary w-full">تایید</button>
            <p id="otp-msg" class="text-sm text-green-600 mt-2"></p>
        </div>
    </div>

<script>
    const supabaseUrl = "https://iqpdwiowrqolqcbnaszt.supabase.co";
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxcGR3aW93cnFvbHFjYm5hc3p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0OTA2NjAsImV4cCI6MjA2ODA2NjY2MH0.hAY20i5GBOflnEDYL4Kygn45VPmlP37fEthB9RbH0E4";
    const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

    let generatedCode = "";
    let currentPhone = "";

    function sendCode() {
        const phone = document.getElementById("phoneInput").value.trim();
        const msgEl = document.getElementById("msg");
        msgEl.textContent = "";

        if (!/^09\d{9}$/.test(phone)) {
            msgEl.textContent = "لطفا شماره موبایل معتبر وارد کنید (با ۰۹ شروع شود).";
            return;
        }
        generatedCode = Math.floor(10000 + Math.random() * 90000).toString();
        currentPhone = phone;
        console.log("کد تولید شده:", generatedCode);
        document.getElementById("step-1").classList.add("hidden");
        document.getElementById("step-2").classList.remove("hidden");
        document.getElementById("otp-msg").textContent = "کد تایید شما: " + generatedCode + " (جهت تست)";
    }

    function verifyCode() {
        const codeInput = document.getElementById("otpInput").value.trim();
        const otpMsg = document.getElementById("otp-msg");
        otpMsg.textContent = "";

        if (codeInput === generatedCode) {
            savePhoneNumber(currentPhone);
        } else {
            otpMsg.textContent = "کد وارد شده صحیح نیست.";
        }
    }

    async function savePhoneNumber(phone) {
        const { data, error } = await supabase
            .from("users_custom_data")
            .upsert([{ phone_number: phone, remaining_share_percent: 100 }], { onConflict: ['phone_number'] });
        if (error) {
            alert("خطا در ذخیره شماره موبایل");
            console.error(error);
        } else {
            alert("ورود با موفقیت انجام شد! به فرم تکمیل پروفایل منتقل می‌شوید.");
            window.location.href = "profile.html?phone=" + phone;
        }
    }

    document.getElementById("phoneInput").addEventListener("keypress", function (e) {
        if (e.key === "Enter") sendCode();
    });
    document.getElementById("otpInput").addEventListener("keypress", function (e) {
        if (e.key === "Enter") verifyCode();
    });
</script>
</body>
</html>
