<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ورود به سامانه تعاونی</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.20/dist/full.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@fontsource/vazirmatn@latest/index.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Vazirmatn, sans-serif; background: linear-gradient(to right, #a8e6cf, #dcedc1); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
        <h1 class="text-2xl font-bold text-center mb-6">ورود به سامانه تعاونی</h1>
        
        <div id="step-1">
            <label class="block mb-2 font-semibold">کد ملی خود را وارد کنید:</label>
            <input type="text" id="nationalIdInput" class="input input-bordered w-full mb-4" placeholder="مثال: 0012345678" maxlength="10">

            <label class="block mb-2 font-semibold">شماره موبایل خود را وارد کنید:</label>
            <input type="tel" id="phoneInput" class="input input-bordered w-full mb-4" placeholder="مثال: 09123456789" maxlength="11">

            <label class="block mb-2 font-semibold">شناسه کاربری بله (Chat ID):</label>
            <input type="text" id="chatIdInput" class="input input-bordered w-full mb-4" placeholder="یک عدد چند رقمی">
            <p class="text-xs text-gray-500 mb-4 -mt-2">برای پیدا کردن شناسه خود، در بله به ربات <span class="font-mono bg-gray-200 p-1 rounded">@userinfobot</span> پیام دهید.</p>
            
            <button id="sendCodeBtn" onclick="requestOtp()" class="btn btn-success w-full">ارسال کد تایید</button>
            <p id="msg" class="text-sm text-red-500 mt-2 text-center"></p>
        </div>

        <div id="step-2" class="hidden">
            <p class="text-center mb-4">یک کد تایید به حساب بله شما ارسال شد.</p>
            <label class="block mb-2 font-semibold">کد تایید را وارد کنید:</label>
            <input type="text" id="otpInput" class="input input-bordered w-full mb-4" maxlength="5">
            
            <button onclick="verifyOtp()" class="btn btn-primary w-full">تایید و ورود</button>
            <p id="otp-msg" class="text-sm text-red-500 mt-2 text-center"></p>
        </div>
    </div>

    <script>
        const supabaseUrl = "https://iqpdwiowrqolqcbnaszt.supabase.co";
        const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxcGR3aW93cnFvbHFjYm5hc3p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0OTA2NjAsImV4cCI6MjA2ODA2NjY2MH0.hAY20i5GBOflnEDYL4Kygn45VPmlP37fEthB9RbH0E4";
        const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

        // آدرس سرور بک‌اند شما که روی Render قرار دارد
        const API_BACKEND_URL = "https://tavonibot.onrender.com";

        async function requestOtp() {
            const nationalId = document.getElementById('nationalIdInput').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();
            const chatId = document.getElementById('chatIdInput').value.trim();
            const msgEl = document.getElementById('msg');
            const sendBtn = document.getElementById('sendCodeBtn');
            
            msgEl.textContent = '';

            // اعتبارسنجی اولیه
            if (!/^\d{10}$/.test(nationalId)) {
                msgEl.textContent = "کد ملی باید ۱۰ رقم باشد.";
                return;
            }
            if (!/^09\d{9}$/.test(phone)) {
                msgEl.textContent = "شماره موبایل معتبر نیست.";
                return;
            }
            if (!/^\d+$/.test(chatId)) {
                msgEl.textContent = "شناسه کاربری بله معتبر نیست.";
                return;
            }

            // غیرفعال کردن دکمه برای جلوگیری از کلیک‌های مکرر
            sendBtn.disabled = true;
            sendBtn.textContent = 'در حال ارسال...';

            try {
                // ارسال اطلاعات به سرور (بک‌اند)
                const response = await fetch(`${API_BACKEND_URL}/request-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        national_id: nationalId,
                        phone_number: phone,
                        chat_id: chatId
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // اگر سرور با موفقیت پاسخ داد، به مرحله بعد برو
                    document.getElementById('step-1').classList.add('hidden');
                    document.getElementById('step-2').classList.remove('hidden');
                } else {
                    // نمایش خطایی که از سمت سرور آمده
                    msgEl.textContent = result.error || 'خطایی رخ داد. لطفاً دوباره تلاش کنید.';
                }

            } catch (error) {
                console.error('Fetch Error:', error);
                msgEl.textContent = 'خطا در برقراری ارتباط با سرور.';
            } finally {
                // فعال کردن مجدد دکمه
                sendBtn.disabled = false;
                sendBtn.textContent = 'ارسال کد تایید';
            }
        }

        async function verifyOtp() {
            // این تابع را در مرحله بعدی خواهیم نوشت.
            // فعلا فقط یک پیام نمایش می‌دهیم.
            const otpMsgEl = document.getElementById('otp-msg');
            otpMsgEl.textContent = "این بخش هنوز تکمیل نشده است.";
        }
    </script>
</body>
</html>
